extends KinematicBody2D

# Constantes
const GRAVIDADE := 20
const VELOCIDADE_MAXIMA := 800
const ACELERACAO := 20
const DESACELERACAO := 5
const FORCA_PULO := -750
const SPINDASH_FORCA_MAX := 1300
const SPINDASH_TEMPO_MAX := 1.0  # tempo máximo de carregamento em segundos
const SPINDASH_DURACAO_MAX := 1.5  # duração máxima em segundos

# Variáveis de movimento
var velocidade := Vector2.ZERO
var direcao := 0
var olhando_para_baixo := false
var carregando_spindash := false
var spin_dash := false
var spin_dash_direcao := 0
var olhando_para_frente := "nada"

# Variáveis novas do spin dash
var tempo_carregando_spindash := 0.0
var spin_dash_timer := 0.0
var spin_dash_velocidade := 0.0


func _process(delta):
	entrada_do_jogador(delta)
	movimentacao(delta)


func entrada_do_jogador(delta):
	if not carregando_spindash:
		if Input.is_action_pressed("ui_right"):
			direcao = 1
			olhando_para_frente = "direita"
		elif Input.is_action_pressed("ui_left"):
			direcao = -1
			olhando_para_frente = "esquerda"
		else:
			direcao = 0

	olhando_para_baixo = Input.is_action_pressed("ui_down")

	# Início do carregamento
	if is_on_floor() and olhando_para_baixo and Input.is_action_pressed("pular"):
		if not carregando_spindash:
			carregando_spindash = true
			tempo_carregando_spindash = 0.0

			# Define a direção baseada no olhar
			if olhando_para_frente == "direita":
				spin_dash_direcao = 1
			elif olhando_para_frente == "esquerda":
				spin_dash_direcao = -1
			else:
				spin_dash_direcao = 1

		# Aumenta o tempo de carregamento (limitado)
		tempo_carregando_spindash = min(tempo_carregando_spindash + delta, SPINDASH_TEMPO_MAX)

	# Quando solta o botão de pulo, ativa o spin dash
	if carregando_spindash and Input.is_action_just_released("pular"):
		carregando_spindash = false
		spin_dash = true

		# Calcula força com base no tempo de carregamento
		var forca_percentual := tempo_carregando_spindash / SPINDASH_TEMPO_MAX
		spin_dash_velocidade = lerp(500, SPINDASH_FORCA_MAX, forca_percentual)
		spin_dash_timer = lerp(0.3, SPINDASH_DURACAO_MAX, forca_percentual)  # Duração proporcional

	if Input.is_action_just_pressed("pular") and is_on_floor() and not carregando_spindash:
		pular()


func movimentacao(delta):
	if spin_dash:
		# Aplica movimento constante durante o tempo de spin dash
		velocidade.x = spin_dash_velocidade * spin_dash_direcao
		spin_dash_timer -= delta
		if spin_dash_timer <= 0:
			spin_dash = false
	else:
		if direcao != 0:
			velocidade.x += ACELERACAO * direcao
			velocidade.x = clamp(velocidade.x, -VELOCIDADE_MAXIMA, VELOCIDADE_MAXIMA)
		else:
			velocidade.x = lerp(velocidade.x, 0, DESACELERACAO * delta)

	# Gravidade
	velocidade.y += GRAVIDADE

	# Movimento
	velocidade = move_and_slide(velocidade, Vector2.UP)


func pular():
	velocidade.y = FORCA_PULO
